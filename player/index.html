<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Shaka + Akamai BBB (image tracks)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.15.9/dist/controls.css">
  <!-- IMPORTANT: use defer so Shaka loads before our inline script runs -->
  <script defer src="https://cdn.jsdelivr.net/npm/shaka-player@4.15.9/dist/shaka-player.ui.min.js"></script>
  <style>
    body { margin:0; background:#111; color:#ddd; font-family:system-ui,sans-serif; }
    .wrap { max-width:960px; margin:20px auto; padding:0 12px; }
    #video { width:100%; background:#000; }
    /* Hide native HTML5 controls completely so only Shaka UI shows */
    video::-webkit-media-controls { display:none !important; }
    video::-webkit-media-controls-enclosure { display:none !important; }
    video::-webkit-media-controls-panel { display:none !important; }
    video::-moz-media-controls { display:none !important; }
    video::-ms-media-controls { display:none !important; }
    .shaka-controls-container { opacity:1 !important; }
    #player { position:relative; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>Shaka + Akamai BBB (DASH image tracks)</h2>
    <div style="margin:8px 0">
      <label>Source:
        <select id="source">
          <option value="local-vtt">Local (MPD + VTT thumbnails)</option>
          <option value="local-dash">Local (DASH stream + image thumbnails)</option>
          <option value="local-hls">Local (HLS stream + image thumbnails)</option>
          <option value="akamai-dash">Remote Akamai (DASH stream + image thumbnails)</option>
        </select>
      </label>
    </div>
  <div id="player" data-shaka-player-container>
    <video id="video" data-shaka-player playsinline muted autoplay></video>
  </div>
</div>

<script>
(async () => {
  // Wait until the Shaka library has actually loaded
  if (!window.shaka) {
    await new Promise((resolve) => {
      const chk = () => window.shaka ? resolve() : setTimeout(chk, 10);
      chk();
    });
  }

  // Install polyfills & set logging AFTER shaka is present
  if (shaka.polyfill && typeof shaka.polyfill.installAll === 'function') {
    shaka.polyfill.installAll();
  }
  if (shaka.log && typeof shaka.log.setLevel === 'function' && shaka.log.Level) {
    shaka.log.setLevel(shaka.log.Level.DEBUG);
  }

  // Serve content from local nginx (web service) or Akamai demo
  const CONTENT_BASE = 'http://localhost:8080';
  const NAME = 'video';
  const AKAMAI_MPD = 'https://dash.akamaized.net/akamai/bbb_30fps/bbb_with_tiled_thumbnails.mpd';
  const params = new URLSearchParams(location.search);
  const allowed = new Set(['local-vtt','local-dash','local-hls','akamai-dash']);
  const qs = (params.get('src') || 'local-vtt').toLowerCase();
  const initialSource = allowed.has(qs) ? qs : 'local-vtt';

  const video  = document.getElementById('video');
  const root   = document.getElementById('player');
  const sourceSel = document.getElementById('source');
  sourceSel.value = initialSource;

  // Create player (without media element), attach, then create UI overlay
  const player = new shaka.Player();
  await player.attach(video);
  let ui = null;
  if (shaka.ui && shaka.ui.Overlay) {
    ui = new shaka.ui.Overlay(player, root, video);
  }

  // Basic config
  player.configure({
    streaming: { lowLatencyMode: false },
    manifest:  { retryParameters: { maxAttempts: 2 } },
    drm:       { servers: {} }
  });

  // Verbose error logging
  player.addEventListener('error', e => console.error('[shaka][player]', e.detail || e));
  if (ui && ui.getControls) ui.getControls().addEventListener('error', e => console.error('[shaka][ui]', e.detail || e));
  video.addEventListener('error', () => console.error('[video]', video.error));

  function getSourceConfig(source) {
    switch (source) {
      case 'akamai-dash':
        return { url: AKAMAI_MPD, addVtt: false };
      case 'local-dash':
        // We will also add sprite VTT for consistency so Safari shows thumbs
        return { url: `${CONTENT_BASE}/${NAME}/stream.mpd`, addVtt: `${CONTENT_BASE}/${NAME}/thumbs/thumbs_sprites.vtt` };
      case 'local-hls':
        return { url: `${CONTENT_BASE}/${NAME}/hls/master.m3u8`, addVtt: `${CONTENT_BASE}/${NAME}/thumbs/thumbs_sprites.vtt` };
      case 'local-vtt':
      default:
        return { url: `${CONTENT_BASE}/${NAME}/stream.mpd`, addVtt: `${CONTENT_BASE}/${NAME}/thumbs/thumbs_sprites.vtt` };
    }
  }

  async function loadSource(source) {
    const { url, addVtt } = getSourceConfig(source);
    try {
      await player.unload();
      await player.load(url);
      console.log('[shaka] Loaded:', source, url);

      if (addVtt) {
        // Use WebVTT thumbnails via Shaka's built-in support for local content
        try {
          const vttUrlAbs = addVtt;
          const vttText = await (await fetch(vttUrlAbs)).text();
          const baseDir = vttUrlAbs.slice(0, vttUrlAbs.lastIndexOf('/') + 1); // .../video/thumbs/
          const fixed = vttText
            .split(/\r?\n/)
            .map(line => line.trim().startsWith('thumbs/') ? (baseDir + line.trim().slice('thumbs/'.length)) : line)
            .join('\n');
          const blob = new Blob([fixed], { type: 'text/vtt' });
          const vttUrl = URL.createObjectURL(blob);
          await player.addThumbnailsTrack(vttUrl);
          console.log('[shaka] thumbnails track added (VTT)');
          setTimeout(() => URL.revokeObjectURL(vttUrl), 30000);
        } catch (err) {
          console.warn('[shaka] failed to add thumbnails track (VTT):', err);
        }
      } else {
        // Rely on DASH/HLS image tracks; Shaka UI should show thumbnails automatically
        const imageTracks = (player.getImageTracks && player.getImageTracks()) || [];
        console.log('[shaka] image tracks detected:', imageTracks.length);
      }
    } catch (e) {
      console.error('[shaka] load failed:', e);
      alert('Load failed. See console.');
    }
  }

  // Initial load based on URL param
  await loadSource(initialSource);

  // Handle user switching
  sourceSel.addEventListener('change', () => {
    const sel = sourceSel.value;
    const url = new URL(location.href);
    url.searchParams.set('src', sel);
    history.replaceState(null, '', url.toString());
    loadSource(sel);
  });
})();
</script>
</body>
</html>